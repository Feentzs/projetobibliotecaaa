<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Configurar Conta — BiblioTec</title>
    <link rel="icon" href="images/logosemtxt.svg">
    <link rel="stylesheet" href="css/home.css" />
    <link rel="stylesheet" href="css/dark-mode.css" id="dark-mode-style">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      /* ===== ACCOUNT PAGE STYLES ===== */
      .account-container {
        max-width: 600px;
        margin: 40px auto;
        padding: 24px;
      }

      .account-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .account-header h1 {
        font-size: 32px;
        font-weight: 700;
        margin: 0 0 8px;
      }

      .account-header p {
        color: var(--muted-text);
        font-size: 16px;
        margin: 0;
      }

      .form-section {
        margin-bottom: 40px;
        padding: 24px;
        background: var(--card);
        border-radius: 12px;
        border: 1px solid #e6e9ef;
      }

      .form-section h2 {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e6e9ef;
      }

      .form-group {
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
      }

      .form-group:last-child {
        margin-bottom: 0;
      }

      .form-group label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 8px;
        display: block;
      }

      .form-group input,
      .form-group textarea {
        padding: 12px 16px;
        border: 1px solid #e6e9ef;
        border-radius: 8px;
        font-family: inherit;
        font-size: 14px;
        color: var(--text);
        background: var(--bg);
        transition: border-color 0.2s;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(74, 103, 223, 0.1);
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .form-group .help-text {
        font-size: 12px;
        color: var(--muted-text);
        margin-top: 6px;
      }

      .form-group .error {
        color: #ef4444;
        font-size: 12px;
        margin-top: 6px;
        display: none;
      }

      .form-group.error input,
      .form-group.error textarea {
        border-color: #ef4444;
      }

      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding-top: 16px;
        border-top: 1px solid #e6e9ef;
      }

      .btn-primary {
        padding: 12px 32px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
      }

      .btn-primary:hover {
        background: #3d4fc4;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(74, 103, 223, 0.3);
      }

      .btn-secondary {
        padding: 12px 32px;
        background: transparent;
        color: var(--text);
        border: 1px solid #e6e9ef;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
      }

      .btn-secondary:hover {
        background: var(--muted);
        border-color: #d1d5db;
      }

      .btn-danger {
        padding: 12px 32px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
      }

      .btn-danger:hover {
        background: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3);
      }

      .success-message {
        display: none;
        background: #d1fae5;
        color: #065f46;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 24px;
        border: 1px solid #a7f3d0;
      }

      .success-message.show {
        display: block;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .danger-zone {
        margin-top: 40px;
        padding: 24px;
        background: #fef2f2;
        border: 2px solid #fee2e2;
        border-radius: 12px;
      }

      .danger-zone h2 {
        color: #dc2626;
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 8px;
      }

      .danger-zone p {
        color: #7f1d1d;
        font-size: 14px;
        margin: 0 0 16px;
      }

      .password-requirements {
        font-size: 12px;
        color: var(--muted-text);
        margin-top: 12px;
        padding: 12px;
        background: var(--bg);
        border-radius: 6px;
        border-left: 3px solid var(--accent);
      }

      .password-requirements ul {
        margin: 0;
        padding-left: 20px;
      }

      .password-requirements li {
        margin-bottom: 4px;
      }

      @media (max-width: 640px) {
        .account-container {
          padding: 16px;
        }

        .account-header h1 {
          font-size: 24px;
        }

        .form-actions {
          flex-direction: column-reverse;
        }

        .btn-primary,
        .btn-secondary,
        .btn-danger {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <header class="site-header sticky-header">
      <div class="container nav">
        <img src="images/logo.svg" alt="BiblioTec Logo" class="logo" id="header-logo" style="width: 180px; height: 44px;">
        <nav class="nav-links">
          <a href="home.html">Início</a>
          <a href="library.html">Minha Biblioteca</a>
        </nav>
        <!-- Botão hambúrguer do usuário -->
        <div class="user-menu-container">
          <input type="checkbox" id="menu_checkbox">
          <label for="menu_checkbox" class="hamburger-menu">
            <div></div>
            <div></div>
            <div></div>
          </label>
          
          <!-- Dropdown do menu -->
          <div class="user-menu-dropdown" id="user-menu-dropdown">
            <div class="user-info">
              <div class="user-avatar">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="1.5" fill="none"/>
                  <path d="M6 20c0-3.3 2.7-6 6-6s6 2.7 6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="user-details">
                <span class="user-name" id="current-username">Usuário</span>
                <span class="user-email" id="current-useremail">usuario@exemplo.com</span>
              </div>
            </div>
            
            <div class="menu-divider"></div>
            
            <div class="menu-items">
              <button type="button" class="menu-item" id="theme-toggle-menu">
                <div class="menu-item-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" id="sun-icon-menu">
                    <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <path d="M12 4V2M12 20V22M4 12H2M6.31412 6.31412L5.5 5.5M17.6859 6.31412L18.5 5.5M6.31412 17.69L5.5 18.5M17.6859 17.69L18.5 18.5M21 12H20" 
                          stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" id="moon-icon-menu" style="display: none;">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" 
                          stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <span class="menu-item-text">Modo Escuro</span>
                <label class="theme-switch">
                  <input type="checkbox" id="theme-switch">
                  <span class="switch-slider"></span>
                </label>
              </button>
              
              <button type="button" class="menu-item" id="account-btn">
                <div class="menu-item-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <path d="M6 20c0-3.3 2.7-6 6-6s6 2.7 6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                </div>
                <span class="menu-item-text">Configurar Conta</span>
              </button>
              
              <button type="button" class="menu-item logout-btn" id="logout-btn">
                <div class="menu-item-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    <path d="M16 17l5-5-5-5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M21 12H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                </div>
                <span class="menu-item-text">Sair</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main>
      <div class="account-container">
        <div class="account-header">
          <h1>⚙️ Configurar Conta</h1>
          <p>Gerencie suas informações pessoais e preferências</p>
        </div>

        <div class="success-message" id="successMessage"></div>

        <!-- Seção de Informações Pessoais -->
        <form class="form-section" id="profileForm">
          <h2>Informações Pessoais</h2>
          
          <div class="form-group">
            <label for="fullName">Nome Completo</label>
            <input type="text" id="fullName" name="fullName" placeholder="Seu nome" />
            <span class="help-text">Este é o nome que aparecerá em sua conta</span>
            <span class="error" id="fullNameError"></span>
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" placeholder="seu@email.com" disabled />
            <span class="help-text">O email não pode ser alterado</span>
          </div>

          <div class="form-group">
            <label for="bio">Bio/Descrição Pessoal</label>
            <textarea id="bio" name="bio" placeholder="Conte-nos sobre você..."></textarea>
            <span class="help-text">Máximo 500 caracteres</span>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" id="profileCancel">Cancelar</button>
            <button type="submit" class="btn-primary">Salvar Alterações</button>
          </div>
        </form>

        <!-- Seção de Senha -->
        <form class="form-section" id="passwordForm">
          <h2>Alterar Senha</h2>
          
          <div class="form-group">
            <label for="currentPassword">Senha Atual</label>
            <input type="password" id="currentPassword" name="currentPassword" placeholder="Digite sua senha atual" />
            <span class="error" id="currentPasswordError"></span>
          </div>

          <div class="form-group">
            <label for="newPassword">Nova Senha</label>
            <input type="password" id="newPassword" name="newPassword" placeholder="Digite uma nova senha" />
            <span class="error" id="newPasswordError"></span>
            <div class="password-requirements">
              <strong>Requisitos:</strong>
              <ul>
                <li>Mínimo de 8 caracteres</li>
                <li>Pelo menos uma letra maiúscula</li>
                <li>Pelo menos um número</li>
                <li>Pelo menos um caractere especial (!@#$%)</li>
              </ul>
            </div>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirmar Nova Senha</label>
            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirme a nova senha" />
            <span class="error" id="confirmPasswordError"></span>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" id="passwordCancel">Cancelar</button>
            <button type="submit" class="btn-primary">Alterar Senha</button>
          </div>
        </form>

        <!-- Seção de Preferências -->
        <form class="form-section" id="preferencesForm">
          <h2>Preferências</h2>
          
          <div class="form-group">
            <label for="language">Idioma</label>
            <select id="language" name="language" style="padding: 12px 16px; border: 1px solid #e6e9ef; border-radius: 8px; background: var(--bg); color: var(--text); font-family: inherit; font-size: 14px;">
              <option value="pt-br">Português (Brasil)</option>
              <option value="en">English</option>
              <option value="es">Español</option>
            </select>
          </div>

          <div class="form-group">
            <label for="theme">Tema Visual</label>
            <select id="theme" name="theme" style="padding: 12px 16px; border: 1px solid #e6e9ef; border-radius: 8px; background: var(--bg); color: var(--text); font-family: inherit; font-size: 14px;">
              <option value="light">Claro</option>
              <option value="dark">Escuro</option>
              <option value="auto">Automático</option>
            </select>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" id="preferencesCancel">Cancelar</button>
            <button type="submit" class="btn-primary">Salvar Preferências</button>
          </div>
        </form>

        <!-- Seção Perigosa -->
        <div class="form-section danger-zone">
          <h2>Zona de Risco</h2>
          <p>Estas ações são irreversíveis. Proceda com cautela.</p>
          <button type="button" class="btn-danger" id="deleteAccountBtn">Deletar Conta Permanentemente</button>
        </div>
      </div>
    </main>

    <script src="js/user-data.js"></script>
    <script src="js/api.js"></script>
    <script src="js/scripts.js"></script>
    <script>
      // ===== GERENCIAMENTO DA PÁGINA DE CONFIGURAÇÕES =====

      document.addEventListener('DOMContentLoaded', function() {
        loadAccountData();
        setupFormHandlers();
        setupMenuHandlers();
      });

      // Carregar dados da conta
      function loadAccountData() {
        const user = loadUserData();
        
        if (!user) {
          window.location.href = 'login.html';
          return;
        }

        // Preencher dados do perfil
        document.getElementById('fullName').value = user.name || '';
        document.getElementById('email').value = user.email || '';
      }

      // Configurar manipuladores de formulários
      function setupFormHandlers() {
        // Formulário de perfil
        const profileForm = document.getElementById('profileForm');
        profileForm.addEventListener('submit', handleProfileSubmit);
        document.getElementById('profileCancel').addEventListener('click', () => {
          profileForm.reset();
          loadAccountData();
        });

        // Formulário de senha
        const passwordForm = document.getElementById('passwordForm');
        passwordForm.addEventListener('submit', handlePasswordSubmit);
        document.getElementById('passwordCancel').addEventListener('click', () => {
          passwordForm.reset();
        });

        // Formulário de preferências
        const preferencesForm = document.getElementById('preferencesForm');
        preferencesForm.addEventListener('submit', handlePreferencesSubmit);
        document.getElementById('preferencesCancel').addEventListener('click', () => {
          preferencesForm.reset();
        });

        // Botão de deletar conta
        document.getElementById('deleteAccountBtn').addEventListener('click', handleDeleteAccount);
      }

      // Configurar menu
      function setupMenuHandlers() {
        const accountBtn = document.getElementById('account-btn');
        if (accountBtn) {
          accountBtn.addEventListener('click', () => {
            window.location.href = 'account.html';
          });
        }
      }

      // Enviar formulário de perfil
      async function handleProfileSubmit(e) {
        e.preventDefault();
        const fullName = document.getElementById('fullName').value.trim();

        if (!fullName || fullName.length < 3) {
          showError('fullNameError', 'Nome deve ter pelo menos 3 caracteres');
          return;
        }

        try {
          // Chamar API para atualizar perfil
          await api.updateProfile({ name: fullName });

          // Atualizar no localStorage
          const user = loadUserData();
          user.name = fullName;
          localStorage.setItem('bibliotec_user', JSON.stringify(user));

          showSuccess('Perfil atualizado com sucesso!');
          document.getElementById('current-username').textContent = fullName;
          clearError('fullNameError');
        } catch (error) {
          console.error('Erro ao atualizar perfil:', error);
          showError('fullNameError', error.message || 'Erro ao salvar alterações');
        }
      }

      // Enviar formulário de senha
      async function handlePasswordSubmit(e) {
        e.preventDefault();
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // Validações
        if (!validatePassword(newPassword)) {
          showError('newPasswordError', 'A senha não atende aos requisitos');
          return;
        }

        if (newPassword !== confirmPassword) {
          showError('confirmPasswordError', 'As senhas não coincidem');
          return;
        }

        try {
          // Chamar API para alterar senha
          await api.changePassword({ currentPassword, newPassword });

          showSuccess('Senha alterada com sucesso!');
          document.getElementById('passwordForm').reset();
          clearError('currentPasswordError');
          clearError('newPasswordError');
          clearError('confirmPasswordError');
        } catch (error) {
          console.error('Erro ao alterar senha:', error);
          showError('currentPasswordError', error.message || 'Erro ao alterar senha');
        }
      }

      // Enviar formulário de preferências
      async function handlePreferencesSubmit(e) {
        e.preventDefault();
        const language = document.getElementById('language').value;
        const theme = document.getElementById('theme').value;

        try {
          // Salvar preferências no localStorage
          const preferences = {
            language: language,
            theme: theme
          };
          localStorage.setItem('userPreferences', JSON.stringify(preferences));

          showSuccess('Preferências salvas com sucesso!');
        } catch (error) {
          console.error('Erro ao salvar preferências:', error);
          showError('preferencesForm', 'Erro ao salvar preferências');
        }
      }

      // Deletar conta
      async function handleDeleteAccount() {
        const confirmed = confirm(
          'Tem certeza que deseja deletar sua conta? Esta ação é irreversível e você perderá todos os seus dados.'
        );

        if (!confirmed) {
          return;
        }

        const finalConfirm = prompt(
          'Digite seu email para confirmar a exclusão da conta:'
        );

        const user = loadUserData();
        if (finalConfirm !== user.email) {
          alert('Email não corresponde. Exclusão cancelada.');
          return;
        }

        try {
          // Chamar API para deletar a conta
          await api.deleteAccount();

          logoutUser();
          alert('Conta deletada com sucesso.');
          window.location.href = 'index.html';
        } catch (error) {
          console.error('Erro ao deletar conta:', error);
          alert('Erro ao deletar conta. Tente novamente.');
        }
      }

      // Funções auxiliares
      function validatePassword(password) {
        const minLength = 8;
        const hasUpperCase = /[A-Z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

        return (
          password.length >= minLength &&
          hasUpperCase &&
          hasNumber &&
          hasSpecialChar
        );
      }

      function showError(elementId, message) {
        const errorEl = document.getElementById(elementId);
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.style.display = 'block';
          errorEl.parentElement.classList.add('error');
        }
      }

      function clearError(elementId) {
        const errorEl = document.getElementById(elementId);
        if (errorEl) {
          errorEl.textContent = '';
          errorEl.style.display = 'none';
          if (errorEl.parentElement) {
            errorEl.parentElement.classList.remove('error');
          }
        }
      }

      function showSuccess(message) {
        const successEl = document.getElementById('successMessage');
        successEl.textContent = message;
        successEl.classList.add('show');

        setTimeout(() => {
          successEl.classList.remove('show');
        }, 3000);
      }
    </script>
  </body>
</html>
